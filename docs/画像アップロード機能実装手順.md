# Cloudflare Images 画像アップロード機能 実装手順

**作成日**: 2025年10月17日
**対象**: unbelong 管理画面 (unbelong-admin)

---

## 📋 概要

管理画面から直接Cloudflare Imagesに画像をアップロードできる機能を実装します。

**現状の問題点:**
- 画像メタデータのみDBに保存される（仮のImage ID）
- 実際の画像ファイルはCloudflare Imagesにアップロードされない
- 手動でCloudflareダッシュボードからアップロードが必要

**実装後:**
- 管理画面から直接画像をアップロード
- 自動的にCloudflare Imagesにアップロード
- Image IDを自動取得してDBに保存

---

## 🔑 必要な情報

### 1. Cloudflare API Token作成

1. Cloudflareダッシュボード → My Profile → API Tokens
2. 「Create Token」ボタンをクリック
3. 「Create Custom Token」を選択
4. 以下の設定：
   - **Token name**: `unbelong-images-upload`
   - **Permissions**:
     - Account | Cloudflare Images | Edit
   - **Account Resources**:
     - Include | `masa162's Account` (または該当アカウント)
   - **TTL**: 任意（推奨: 1年）
5. 「Continue to summary」→ 「Create Token」
6. **トークンをコピーして安全に保管**（二度と表示されません）

### 2. 環境変数設定

以下の環境変数が必要です：

```env
# Cloudflare Account ID
CLOUDFLARE_ACCOUNT_ID=c677241d7d66ff80103bab9f142128ab

# Cloudflare Images API Token (Edit権限必要)
CLOUDFLARE_IMAGES_API_TOKEN=your_api_token_here

# Account Hash (画像配信用)
CLOUDFLARE_ACCOUNT_HASH=wdR9enbrkaPsEgUtgFORrw
```

---

## 📝 実装ステップ

### ステップ1: 環境変数設定

#### 1-1. ローカル開発環境

**ファイル**: `/mnt/d/github/unbelongcomic/apps/admin/.env.local`

```env
CLOUDFLARE_ACCOUNT_ID=c677241d7d66ff80103bab9f142128ab
CLOUDFLARE_IMAGES_API_TOKEN=your_api_token_here
CLOUDFLARE_ACCOUNT_HASH=wdR9enbrkaPsEgUtgFORrw
```

#### 1-2. Cloudflare Pages本番環境

1. Cloudflareダッシュボード → Workers & Pages
2. `unbelong-admin` プロジェクトを選択
3. Settings → Environment variables
4. Production環境に以下を追加：
   - `CLOUDFLARE_ACCOUNT_ID`
   - `CLOUDFLARE_IMAGES_API_TOKEN`
   - `CLOUDFLARE_ACCOUNT_HASH`

---

### ステップ2: Next.js API Route作成

#### 2-1. APIルートファイル作成

**ファイル**: `apps/admin/app/api/upload-image/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';

export const runtime = 'edge';

export async function POST(request: NextRequest) {
  try {
    // 認証チェック（Basic認証がかかっているので、ここでは省略可）

    const formData = await request.formData();
    const file = formData.get('file') as File;

    if (!file) {
      return NextResponse.json(
        { success: false, error: 'ファイルが指定されていません' },
        { status: 400 }
      );
    }

    // ファイルサイズチェック（10MB制限）
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
    if (file.size > MAX_FILE_SIZE) {
      return NextResponse.json(
        { success: false, error: 'ファイルサイズが大きすぎます（最大10MB）' },
        { status: 400 }
      );
    }

    // ファイルタイプチェック
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
      return NextResponse.json(
        { success: false, error: 'サポートされていないファイル形式です' },
        { status: 400 }
      );
    }

    // Cloudflare Images APIにアップロード
    const accountId = process.env.CLOUDFLARE_ACCOUNT_ID;
    const apiToken = process.env.CLOUDFLARE_IMAGES_API_TOKEN;

    if (!accountId || !apiToken) {
      return NextResponse.json(
        { success: false, error: 'Cloudflare API設定が不足しています' },
        { status: 500 }
      );
    }

    // FormDataを作成（Cloudflare Images API用）
    const uploadFormData = new FormData();
    uploadFormData.append('file', file);

    // Cloudflare Images APIにアップロード
    const uploadResponse = await fetch(
      `https://api.cloudflare.com/client/v4/accounts/${accountId}/images/v1`,
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiToken}`,
        },
        body: uploadFormData,
      }
    );

    const uploadResult = await uploadResponse.json();

    if (!uploadResult.success) {
      console.error('Cloudflare Images upload error:', uploadResult);
      return NextResponse.json(
        { success: false, error: '画像のアップロードに失敗しました', details: uploadResult.errors },
        { status: 500 }
      );
    }

    // アップロード成功
    const imageData = uploadResult.result;

    return NextResponse.json({
      success: true,
      data: {
        id: imageData.id,
        filename: imageData.filename,
        uploaded: imageData.uploaded,
        variants: imageData.variants,
      },
    });

  } catch (error) {
    console.error('Image upload error:', error);
    return NextResponse.json(
      { success: false, error: '画像のアップロードに失敗しました' },
      { status: 500 }
    );
  }
}
```

---

### ステップ3: フロントエンド実装

#### 3-1. 画像管理ページの修正

**ファイル**: `apps/admin/app/dashboard/images/page.tsx`

**修正箇所**: `handleUpload` 関数を以下のように変更

```typescript
const handleUpload = async () => {
  if (!selectedFile) return;

  setUploading(true);
  try {
    // 1. Cloudflare Imagesにアップロード
    const formData = new FormData();
    formData.append('file', selectedFile);

    const uploadResponse = await fetch('/api/upload-image', {
      method: 'POST',
      body: formData,
    });

    const uploadResult = await uploadResponse.json();

    if (!uploadResult.success) {
      throw new Error(uploadResult.error || '画像のアップロードに失敗しました');
    }

    const imageId = uploadResult.data.id;

    // 2. DBに画像メタデータを保存
    await imagesApi.create({
      id: imageId,
      filename: uploadResult.data.filename || selectedFile.name,
      alt_text: '',
      format: selectedFile.type,
      size: selectedFile.size,
    });

    alert('画像をアップロードしました');
    setSelectedFile(null);
    loadImages();
  } catch (error) {
    console.error('画像のアップロードに失敗しました:', error);
    alert(`画像のアップロードに失敗しました: ${error instanceof Error ? error.message : '不明なエラー'}`);
  } finally {
    setUploading(false);
  }
};
```

---

### ステップ4: TypeScript型定義（オプション）

**ファイル**: `apps/admin/types/cloudflare.ts` (新規作成)

```typescript
export interface CloudflareImagesUploadResponse {
  success: boolean;
  result?: {
    id: string;
    filename: string;
    uploaded: string;
    requireSignedURLs: boolean;
    variants: string[];
  };
  errors?: Array<{
    code: number;
    message: string;
  }>;
}
```

---

### ステップ5: テスト

#### 5-1. ローカル環境でテスト

1. `.env.local` に環境変数を設定
2. 開発サーバー起動: `npm run dev`
3. 管理画面にアクセス: `http://localhost:3000/dashboard/images`
4. 画像ファイルを選択してアップロード
5. 成功メッセージとImage IDを確認
6. 画像一覧でサムネイルが表示されることを確認

#### 5-2. エラーハンドリングテスト

- 大きすぎるファイル（>10MB）をアップロード → エラーメッセージ確認
- サポートされていない形式（.pdf等）をアップロード → エラーメッセージ確認
- ネットワークエラー → エラーメッセージ確認

#### 5-3. 本番環境デプロイ前チェック

- [ ] 環境変数がCloudflare Pagesに設定されている
- [ ] APIトークンの権限が正しい（Cloudflare Images Edit）
- [ ] ローカルでアップロードが成功する
- [ ] 画像一覧でサムネイルが表示される

---

### ステップ6: デプロイ

#### 6-1. コミット&プッシュ

```bash
cd /mnt/d/github/unbelongcomic/apps/admin

git add .
git commit -m "feat: Cloudflare Images直接アップロード機能を実装

- Next.js API Route (/api/upload-image) を追加
- フロントエンドから直接画像アップロード可能に
- ファイルサイズ・形式のバリデーション
- Cloudflare Images APIとの連携

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

git push origin main
```

#### 6-2. Cloudflare Pagesで自動デプロイ

- GitHubにプッシュ後、自動的にデプロイが開始
- ビルドログを確認
- デプロイ完了後、本番環境でテスト

---

## 🔒 セキュリティ考慮事項

### 1. APIトークンの管理

- **絶対にコードにハードコードしない**
- 環境変数で管理
- `.env.local` を `.gitignore` に追加済みか確認
- 定期的にトークンをローテーション

### 2. ファイルアップロードの制限

- ファイルサイズ制限（10MB）
- ファイル形式の検証（画像のみ）
- アップロード回数制限（レート制限）を検討

### 3. 認証

- 管理画面全体にBasic認証がかかっている
- API Routeも同様に保護される

---

## 🐛 トラブルシューティング

### エラー: "Cloudflare API設定が不足しています"

**原因**: 環境変数が設定されていない

**解決策**:
- ローカル: `.env.local` を作成して環境変数を設定
- 本番: Cloudflare Pagesの環境変数設定を確認

### エラー: "Unable to authenticate request"

**原因**: APIトークンが無効または権限不足

**解決策**:
- APIトークンを再作成
- 権限が `Cloudflare Images: Edit` になっているか確認

### エラー: "画像のアップロードに失敗しました"

**原因**: ネットワークエラーまたはCloudflare API側のエラー

**解決策**:
- ブラウザのコンソールログを確認
- Cloudflare APIステータスを確認: https://www.cloudflarestatus.com/

### 画像が表示されない

**原因**: Account Hashが間違っている

**解決策**:
- `CLOUDFLARE_ACCOUNT_HASH=wdR9enbrkaPsEgUtgFORrw` が正しく設定されているか確認
- `getImageUrl()` 関数が正しいAccount Hashを使用しているか確認

---

## 📊 完成後の動作フロー

```
┌─────────────┐
│ ユーザー     │
│ (管理画面)   │
└──────┬──────┘
       │ 1. 画像ファイル選択
       │    「アップロード」ボタンクリック
       ▼
┌─────────────────────────────┐
│ フロントエンド                 │
│ (app/dashboard/images/page.tsx) │
└──────┬──────────────────────┘
       │ 2. FormDataを作成
       │    fetch('/api/upload-image')
       ▼
┌─────────────────────────────┐
│ Next.js API Route            │
│ (app/api/upload-image/route.ts) │
└──────┬──────────────────────┘
       │ 3. バリデーション
       │    - ファイルサイズチェック
       │    - ファイル形式チェック
       ▼
┌─────────────────────────────┐
│ Cloudflare Images API        │
│ POST /accounts/{id}/images/v1 │
└──────┬──────────────────────┘
       │ 4. 画像アップロード成功
       │    Image ID返却
       ▼
┌─────────────────────────────┐
│ Next.js API Route            │
│ Image IDを返す               │
└──────┬──────────────────────┘
       │ 5. Image ID受信
       ▼
┌─────────────────────────────┐
│ フロントエンド                 │
│ imagesApi.create() 呼び出し   │
└──────┬──────────────────────┘
       │ 6. DBにメタデータ保存
       ▼
┌─────────────────────────────┐
│ Workers API                  │
│ POST /images                 │
└──────┬──────────────────────┘
       │ 7. D1データベースに保存
       ▼
┌─────────────────────────────┐
│ D1 Database                  │
│ imagesテーブルにINSERT        │
└─────────────────────────────┘
       │ 8. 成功レスポンス
       ▼
┌─────────────────────────────┐
│ フロントエンド                 │
│ 画像一覧を再読み込み            │
│ サムネイル表示                 │
└─────────────────────────────┘
```

---

## ✅ チェックリスト

実装前:
- [ ] Cloudflare API Tokenを作成
- [ ] 環境変数をローカルとCloudflare Pagesに設定
- [ ] Account Hashが正しいか確認（wdR9enbrkaPsEgUtgFORrw）

実装中:
- [ ] API Routeファイル作成 (`app/api/upload-image/route.ts`)
- [ ] フロントエンドの `handleUpload` 関数を修正
- [ ] エラーハンドリングを実装
- [ ] ファイルバリデーションを実装

実装後:
- [ ] ローカル環境でアップロードテスト成功
- [ ] 大きいファイルのエラーハンドリング確認
- [ ] サポート外形式のエラーハンドリング確認
- [ ] 画像一覧でサムネイル表示確認
- [ ] コミット＆プッシュ
- [ ] 本番環境デプロイ成功
- [ ] 本番環境でアップロードテスト成功

---

## 📚 参考資料

- [Cloudflare Images API Documentation](https://developers.cloudflare.com/images/cloudflare-images/upload-images/upload-via-url/)
- [Next.js API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
- [Cloudflare Images Pricing](https://www.cloudflare.com/ja-jp/developer-platform/cloudflare-images/)

---

**注意**: このドキュメントは実装ガイドです。実際の実装時には、プロジェクトの要件に応じて調整してください。
